<!doctype html>
<meta charset="utf-8"/>
<title>MAPAKITA — Mapillary Street View</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .wrap{ position:absolute; inset:0; display:grid; grid-template-columns: 50% 50%; }
  #map{ width:100%; height:100% }
  #viewer{ width:100%; height:100% }
  .panel{ position:fixed; right:12px; top:12px; width:360px; max-width:92vw; background:#fff; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,.12); padding:12px; z-index:11; }
  .panel h2{ margin:0 0 6px 0; font-size:16px }
  .panel .muted{ color:#6b7280; font-size:12px }
  .photos{ display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-top:8px }
  .photos img{ width:100%; height:80px; object-fit:cover; border-radius:8px; border:1px solid #eee }
  .chip{ display:inline-block; padding:4px 8px; background:#eef4ff; color:#0b66ff; border-radius:999px; font-weight:600; font-size:12px }
  .link{ color:#0b66ff; text-decoration:none; font-weight:600 }
</style>
<div class="wrap">
  <div id="map"></div>
  <div id="viewer"></div>
</div>
<div class="panel" id="info" style="display:none"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.min.css"/>
<script>
let map, layer, allFeatures=null, viewer;
const center = [14.9545,120.8969];

async function init(){
  map = L.map('map').setView(center, 13);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
  const res = await fetch('data/projects.geojson'); const gj = await res.json();
  allFeatures = gj.features;
  render();

  // Mapillary viewer (needs a Client ID — get one free at mapillary.com)
  viewer = new mapillary.Viewer({
    container: 'viewer',
    apiClient: 'YOUR_MAPILLARY_CLIENT_ID', // TODO: replace
    imageId: null,
  });
}

function render(){
  if(layer) map.removeLayer(layer);
  layer = L.geoJSON({type:'FeatureCollection',features:allFeatures}, {
    onEachFeature: (f,l) => {
      const p = f.properties||{}, id = f.id;
      l.bindPopup(`<b>${p.title||id}</b><br/><small>${p.agency||''}</small>`);
      l.on('click', ()=> focus(f));
    }
  }).addTo(map);
  try{ map.fitBounds(layer.getBounds().pad(0.2)); }catch{}
}

function focus(f){
  const p = f.properties||{}, id = f.id;
  document.getElementById('info').innerHTML = `
    <h2>${p.title||id}</h2>
    <div class="muted">${p.agency||''}</div>
    <div style="margin:6px 0">
      <span class="chip">${p.status||'Status: —'}</span>
      ${p.barangay?` <span class="chip">${p.barangay}</span>`:''}
    </div>
    <div><b>ABC:</b> ${peso(p.abc_php)}</div>
    ${p.source_url?`<div style="margin-top:6px"><a class="link" href="${p.source_url}" target="_blank">Source</a></div>`:''}
  `;
  document.getElementById('info').style.display='block';
  // center map
  if(f.geometry && f.geometry.coordinates){
    const lng=f.geometry.coordinates[0], lat=f.geometry.coordinates[1];
    map.panTo([lat,lng]);
  }
}

function peso(n){
  if(n==null || n==='') return '—';
  const x = Number(n); if(!isFinite(x)) return String(n);
  return '₱'+x.toLocaleString();
}

init();
</script>
